# üîÑ Migration Guide

## Jak p≈ôepsat st√°vaj√≠c√≠ ƒç√°sti aplikace na nov√Ω pattern

Tento guide ukazuje jak **postupnƒõ** migrovat st√°vaj√≠c√≠ aplikaci na nov√Ω pattern s INavigator a IWindowManager.

---

## üìã F√°ze migrace

### **F√°ze 1: P≈ôid√°n√≠ IWindowManager do st√°vaj√≠c√≠ aplikace**

#### **1.1 P≈ôidat IWindowManager do ServicesModule.cs**
```csharp
public class ServicesModule : Module
{
    protected override void Load(ContainerBuilder builder)
    {
        builder.RegisterType<ViewLocator>()
               .As<IViewLocator>()
               .SingleInstance();
        
        // P≈òIDAT:
        builder.RegisterType<WindowManager>()
               .As<IWindowManager>()
               .InstancePerLifetimeScope();
        
        // ... zbytek registrac√≠
    }
}
```

#### **1.2 Zmƒõnit MainViewModel**
```csharp
// P≈òED:
public MainViewModel(INavigator navigator, ...)

// PO:
public MainViewModel(IWindowManager windowManager, ...)
```

#### **1.3 Zmƒõnit v≈°echny ViewModels kter√© otev√≠raj√≠ okna**
```csharp
// P≈òED:
_navigator.ShowWindow<ProductsViewModel>();

// PO:
_windowManager.ShowWindow<ProductsViewModel>();

// Dialog:
// P≈òED:
var result = await _navigator.ShowDialogAsync<EditProductViewModel, EditProductResult>(...);

// PO:
var result = await _windowManager.ShowDialogAsync<EditProductViewModel, EditProductResult>(...);
```

---

### **F√°ze 2: Roz≈°√≠≈ôen√≠ st√°vaj√≠c√≠ch model≈Ø**

#### **2.1 Roz≈°√≠≈ôit Customer model**
```csharp
public class Customer
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    
    // P≈òIDAT:
    public string Phone { get; set; } = string.Empty;
    public string CompanyName { get; set; } = string.Empty;
    public string TaxId { get; set; } = string.Empty;
    public CustomerType Type { get; set; } = CustomerType.Individual;
    
    public List<Address> Addresses { get; set; } = new(); // NOV√Å RELACE
    public List<Order> Orders { get; set; } = new();
}

// P≈òIDAT NOV√â ENTITY:
public class Address { /* viz DemoAddress.cs */ }
public enum CustomerType { Individual, Business }
```

#### **2.2 Roz≈°√≠≈ôit Product model**
```csharp
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    
    // P≈òIDAT:
    public string Description { get; set; } = string.Empty;
    public string Barcode { get; set; } = string.Empty;
    public decimal Price { get; set; }
    public int Stock { get; set; }
    public decimal Weight { get; set; }
    public string Unit { get; set; } = "pcs";
    
    public int? CategoryId { get; set; } // NOV√Å RELACE
    public ProductCategory? Category { get; set; }
    
    public List<OrderItem> OrderItems { get; set; } = new();
}

// P≈òIDAT NOVOU ENTITU:
public class ProductCategory { /* viz DemoProductCategory.cs */ }
```

#### **2.3 Aktualizovat AppDbContext**
```csharp
public class AppDbContext : DbContext
{
    public DbSet<Customer> Customers => Set<Customer>();
    public DbSet<Product> Products => Set<Product>();
    public DbSet<Order> Orders => Set<Order>();
    public DbSet<OrderItem> OrderItems => Set<OrderItem>();
    
    // P≈òIDAT:
    public DbSet<Address> Addresses => Set<Address>();
    public DbSet<ProductCategory> Categories => Set<ProductCategory>();
    
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);
        
        // Existing relationships...
        
        // P≈òIDAT:
        modelBuilder.Entity<Customer>()
            .HasMany(c => c.Addresses)
            .WithOne(a => a.Customer)
            .HasForeignKey(a => a.CustomerId)
            .OnDelete(DeleteBehavior.Cascade);
        
        modelBuilder.Entity<ProductCategory>()
            .HasMany(c => c.Products)
            .WithOne(p => p.Category)
            .HasForeignKey(p => p.CategoryId)
            .OnDelete(DeleteBehavior.SetNull);
    }
}
```

#### **2.4 Migrace datab√°ze**
```bash
# Smazat starou datab√°zi
rm DemoDb.db

# Nebo vytvo≈ôit migraci
dotnet ef migrations add AddAddressesAndCategories
dotnet ef database update
```

---

### **F√°ze 3: P≈ôid√°n√≠ Detail Views**

#### **3.1 Vytvo≈ôit CustomerDetailViewModel**
Pou≈æijte `DemoCustomerDetailViewModel.cs` jako ≈°ablonu:
- Zmƒõ≈àte namespace z `.Demo` na hlavn√≠
- Zmƒõ≈àte `DemoCustomer` na `Customer`
- Zmƒõ≈àte `DemoAddress` na `Address`
- Aktualizujte handlery na hlavn√≠ (ne Demo)

#### **3.2 Vytvo≈ôit CustomerDetailWindow.xaml**
Pou≈æijte `DemoCustomerDetailWindow.xaml` jako ≈°ablonu

#### **3.3 P≈ôidat ViewDetail command do CustomersViewModel**
```csharp
[RelayCommand(CanExecute = nameof(CanViewDetail))]
private async Task ViewDetailAsync()
{
    if (SelectedCustomer == null) return;
    
    await _windowManager.ShowDialogAsync<CustomerDetailViewModel, bool>(
        new CustomerDetailParams { CustomerId = SelectedCustomer.Id }
    );
    
    await LoadCustomersAsync();
}

private bool CanViewDetail() => SelectedCustomer != null && !IsBusy;
```

#### **3.4 P≈ôidat button do CustomersWindow.xaml**
```xml
<Button Content="üëÅÔ∏è View Detail" 
        Command="{Binding ViewDetailCommand}"
        ... />
```

#### **3.5 Opakovat pro Products**
- ProductDetailViewModel
- ProductDetailWindow
- P≈ôidat ViewDetail do ProductsViewModel

---

### **F√°ze 4: P≈ôepsat Workflow na INavigator**

#### **4.1 Vytvo≈ôit WorkflowHostViewModel**
```csharp
public partial class WorkflowHostViewModel : BaseViewModel, IAsyncInitializable
{
    private readonly INavigator _navigator;
    
    public async Task InitializeAsync()
    {
        await _navigator.NavigateToAsync<WorkflowStep1ViewModel>();
    }
}
```

#### **4.2 Rozdƒõlit OrderWorkflowViewModel na kroky**
- WorkflowStep1ViewModel (Select Customer)
- WorkflowStep2ViewModel (Add Products)
- WorkflowStep3ViewModel (Review)

Pou≈æijte `DemoWorkflowStep*.cs` jako ≈°ablony.

#### **4.3 Vytvo≈ôit WorkflowHostWindow.xaml**
```xml
<local:ScopedWindow ...>
    <ContentControl Content="{Binding}" />
</local:ScopedWindow>
```

#### **4.4 Update code-behind**
```csharp
public partial class WorkflowHostWindow : ScopedWindow
{
    private async Task OnLoadedAsync()
    {
        if (DataContext is WorkflowHostViewModel vm)
        {
            var navigator = MyScope.Resolve<INavigator>() as Navigator;
            navigator?.SetHostWindow(this);
            
            await vm.InitializeAsync();
        }
    }
}
```

---

## üìä Postupnost migrace (doporuƒçeno):

1. ‚úÖ **F√°ze 1** - IWindowManager (1 den)
   - Minim√°ln√≠ zmƒõny
   - Okam≈æit√Ω benefit
   - St√°vaj√≠c√≠ k√≥d st√°le funguje

2. ‚úÖ **F√°ze 2** - Roz≈°√≠≈ôen√© modely (2-3 dny)
   - P≈ôeru≈°en√≠ slu≈æby kv≈Øli DB migraci
   - Backup datab√°ze!
   - Aktualizace handler≈Ø

3. ‚úÖ **F√°ze 3** - Detail Views (1-2 dny)
   - P≈ôid√°n√≠ hodnoty pro u≈æivatele
   - ≈Ω√°dn√© breaking changes

4. ‚úÖ **F√°ze 4** - Workflow s INavigator (2-3 dny)
   - Nejvƒõt≈°√≠ zmƒõna
   - ƒåist≈°√≠ architektura
   - Lep≈°√≠ testovatelnost

---

## ‚ö†Ô∏è Breaking Changes:

### **Database Schema Changes**
- Nov√© tabulky: `Addresses`, `ProductCategories`
- Nov√© sloupce v `Customers`: Phone, CompanyName, TaxId, Type
- Nov√© sloupce v `Products`: Description, Barcode, Weight, Unit, CategoryId

**≈òe≈°en√≠:**
1. Backup datab√°ze
2. Smazat `DemoDb.db` a nechat vytvo≈ôit novou
3. NEBO vytvo≈ôit EF Core migrace

### **API Changes**
- `INavigator` rozdƒõleno na `INavigator` + `IWindowManager`
- V≈°echny ViewModels pou≈æ√≠vaj√≠c√≠ `INavigator.ShowWindow()` mus√≠ zmƒõnit na `IWindowManager`

---

## üéØ Koneƒçn√Ω stav po migraci:

```
Application Structure:
‚îú‚îÄ‚îÄ INavigator - ViewModel navigation (workflows)
‚îú‚îÄ‚îÄ IWindowManager - Physical window management
‚îú‚îÄ‚îÄ Extended Models - Customer, Product s pln√Ωmi daty
‚îú‚îÄ‚îÄ Detail Views - Zobrazen√≠ v≈°ech dat vƒçetnƒõ relac√≠
‚îú‚îÄ‚îÄ CQRS Handlers - Pro roz≈°√≠≈ôen√© entity
‚îî‚îÄ‚îÄ Workflow s Navigation - ƒåist≈°√≠ ne≈æ CurrentStep pattern
```

---

## üìù Checklist pro ka≈ædou f√°zi:

### **Po F√°zi 1:**
- [ ] Build bez chyb
- [ ] V≈°echna okna se otev√≠raj√≠
- [ ] Dialogy funguj√≠
- [ ] Console logs ukazuj√≠ spr√°vn√© service usage

### **Po F√°zi 2:**
- [ ] Database migrace probƒõhla
- [ ] Data jsou seedov√°na
- [ ] V≈°echny CRUD operace funguj√≠
- [ ] Relace jsou naƒç√≠t√°ny spr√°vnƒõ

### **Po F√°zi 3:**
- [ ] Detail views se otev√≠raj√≠
- [ ] V≈°echna roz≈°√≠≈ôen√° data jsou viditeln√°
- [ ] Edit v detail view funguje
- [ ] Adresy/Kategorie jsou zobrazeny

### **Po F√°zi 4:**
- [ ] Workflow naviguje mezi kroky
- [ ] Back navigation funguje
- [ ] Workflow state se p≈ôed√°v√°
- [ ] Order creation funguje

---

**üí° TIP:** Nemus√≠te migrovat v≈°echno najednou! Advanced Demo modul ukazuje jak to m√° vypadat, m≈Ø≈æete postupovat krok za krokem.
